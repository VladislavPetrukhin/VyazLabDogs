<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Запросы</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon_dog.ico') }}">
</head>
<body>
    <h1>Запросы</h1>
    <nav>
        <a href="/">Главная</a> |
        <a href="/search">Поиск</a> |
        <a href="/view">Собаки</a> |
        <a href="/add">Добавить собаку</a> |
        <a href="/breeds">Породы</a> |
        <a href="/locations">Места размещения</a> |
        <a href="/vet_examinations">Ветеринарные осмотры</a> |
        <a href="/stats">Статистика</a> |
        <a href="/queries">Запросы</a>
    </nav>

    {% if errors %}
        <ul class="errors">
            {% for error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <h2>Поиск по атрибутам</h2>
    <form method="POST">
        <label for="attribute1">Выберите первый атрибут:</label><br>
        <select name="attribute1">
    {% for key, attr in attributes.items() %}
        <option value="{{ key }}">{{ attr.label }}</option>
    {% endfor %}
</select>
{% if attributes[attribute1].is_date %}
    <input type="date" name="search_min1" value="{{ search_min1 }}">
    <input type="date" name="search_max1" value="{{ search_max1 }}">
{% elif attributes[attribute1].type == 'number' %}
    <input type="number" name="search_min1" placeholder="Мин. значение" value="{{ search_min1 }}">
    <input type="number" name="search_max1" placeholder="Макс. значение" value="{{ search_max1 }}">
{% else %}
    <input type="text" name="search_min1" placeholder="Значение" value="{{ search_min1 }}">
{% endif %}

        <label for="attribute2">Выберите второй атрибут (опционально):</label><br>
        <select name="attribute2" id="attribute2">
            <option value="">-- Выберите атрибут --</option>
            {% for key, attr in attributes.items() %}
                <option value="{{ key }}" {% if key == selected_attribute2 %}selected{% endif %}>{{ attr.label }}</option>
            {% endfor %}
        </select><br>
        <div id="input_container2">
            <input type="text" name="search_min2" id="search_min2" value="{{ search_min2 or '' }}">
        </div>

        <button type="submit">Найти</button>
    </form>

    {% if results %}
        <h2>Результаты поиска</h2>
        <table>
            <tr>
                <th>ID</th>
                <th>Кличка</th>
                <th>Порода</th>
                <th>Место размещения</th>
                <th>Дата рождения</th>
                <th>Дата регистрации</th>
            </tr>
            {% for result in results %}
            <tr>
                <td>{{ result['id'] }}</td>
                <td>{{ result['name'] }}</td>
                <td>{{ result['breed_name'] }}</td>
                <td>{{ result['location_name'] or 'Не указано' }}</td>
                <td>{{ result['birth_date'] or 'Не указано' }}</td>
                <td>{{ result['registration_date'] or 'Не указано' }}</td>
            </tr>
            {% endfor %}
        </table>
    {% endif %}

    <script>
        const attributeSelect1 = document.getElementById('attribute1');
        const inputContainer1 = document.getElementById('input_container1');
        const attributeSelect2 = document.getElementById('attribute2');
        const inputContainer2 = document.getElementById('input_container2');

        const breeds = {{ breeds|tojson|safe }};
        const locations = {{ locations|tojson|safe }};
        const numericAttributes = {{ numeric_attributes|tojson|safe }};

        function updateInputContainer(selectElement, containerElement, isFirst) {
            const selectedValue = selectElement.value;
            containerElement.innerHTML = '';

            if (!selectedValue) {
                containerElement.innerHTML = `<input type="text" name="${isFirst ? 'search_min1' : 'search_min2'}" id="${isFirst ? 'search_min1' : 'search_min2'}" value="${isFirst ? '{{ search_min1 or '' }}' : '{{ search_min2 or '' }}'}" ${isFirst ? 'required' : ''}>`;
            } else if (selectedValue === 'breed_name') {
                containerElement.innerHTML = `<select name="${isFirst ? 'search_min1' : 'search_min2'}" id="${isFirst ? 'search_min1' : 'search_min2'}" ${isFirst ? 'required' : ''}>` +
                    '<option value="">-- Выберите породу --</option>' +
                    breeds.map(breed => `<option value="${breed}" ${breed === (isFirst ? '{{ search_min1 }}' : '{{ search_min2 }}') ? 'selected' : ''}>${breed}</option>`).join('') +
                    '</select>';
            } else if (selectedValue === 'location_name') {
                containerElement.innerHTML = `<select name="${isFirst ? 'search_min1' : 'search_min2'}" id="${isFirst ? 'search_min1' : 'search_min2'}" ${isFirst ? 'required' : ''}>` +
                    '<option value="">-- Выберите место --</option>' +
                    locations.map(location => `<option value="${location}" ${location === (isFirst ? '{{ search_min1 }}' : '{{ search_min2 }}') ? 'selected' : ''}>${location}</option>`).join('') +
                    '</select>';
            } else if (numericAttributes.includes(selectedValue)) {
                containerElement.innerHTML = `<label for="${isFirst ? 'search_min1' : 'search_min2'}">Минимальное значение:</label><br>` +
                    `<input type="text" name="${isFirst ? 'search_min1' : 'search_min2'}" id="${isFirst ? 'search_min1' : 'search_min2'}" value="${isFirst ? '{{ search_min1 or '' }}' : '{{ search_min2 or '' }}'}" ${isFirst ? 'required' : ''}><br>` +
                    `<label for="${isFirst ? 'search_max1' : 'search_max2'}">Максимальное значение (опционально):</label><br>` +
                    `<input type="text" name="${isFirst ? 'search_max1' : 'search_max2'}" id="${isFirst ? 'search_max1' : 'search_max2'}" value="${isFirst ? '{{ search_max1 or '' }}' : '{{ search_max2 or '' }}'}">`;
            } else {
                containerElement.innerHTML = `<input type="text" name="${isFirst ? 'search_min1' : 'search_min2'}" id="${isFirst ? 'search_min1' : 'search_min2'}" value="${isFirst ? '{{ search_min1 or '' }}' : '{{ search_min2 or '' }}'}" ${isFirst ? 'required' : ''}>`;
            }
        }

        attributeSelect1.addEventListener('change', function() {
            updateInputContainer(this, inputContainer1, true);
        });

        attributeSelect2.addEventListener('change', function() {
            updateInputContainer(this, inputContainer2, false);
        });

        window.addEventListener('load', function() {
            updateInputContainer(attributeSelect1, inputContainer1, true);
            updateInputContainer(attributeSelect2, inputContainer2, false);
        });
    </script>
</body>
</html>